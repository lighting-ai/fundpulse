import { describe, it, expect } from 'vitest';
import { parseTencentIndex } from './tencent';

describe('parseTencentIndex', () => {
  // 使用用户提供的完整实际数据（包含沪深、港股、美股）
  const mockData = `v_sh000001="1~上证指数~000001~4062.55~4117.95~4079.71~462969958~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-55.40~-1.35~4103.41~4059.79~4062.55/462969958/747767355652~462969958~74776736~0.97~17.27~~4103.41~4059.79~1.06~623771.79~663766.53~0.00~-1~-1~1.07~0~4088.15~~~~~~74776735.5652~0.0000~0~ ~ZS~2.36~-1.70~~~~4190.87~3040.69~-1.25~0.97~1.37~4785495256275~~-22.58~20.38~4785495256275~~~24.98~-0.08~~CNY~0~~0.00~0~"; v_sh000016="1~上证50~000016~3036.62~3066.50~3036.84~48720550~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-29.88~-0.97~3076.02~3034.42~3036.62/48720550/126290617137~48720550~12629062~0.29~11.63~~3076.02~3034.42~1.36~230945.21~239064.77~0.00~-1~-1~1.07~0~3055.02~~~~~~12629061.7137~0.0000~0~ ~ZS~0.18~-0.43~~~~3177.74~2457.08~-1.28~-2.04~-0.27~1666486871649~~-8.23~12.13~1666486871649~~~17.53~-0.12~~CNY~0~~0.00~0~"; v_sh000300="1~沪深300~000300~4656.07~4706.34~4674.28~186964274~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-50.27~-1.07~4716.61~4651.51~4656.07/186964274/467245011670~186964274~46724501~0.57~14.04~~4716.61~4651.51~1.38~517935.68~544539.34~0.00~-1~-1~1.02~0~4690.29~~~~~~46724501.1670~0.0000~0~ ~ZS~0.56~-1.08~~~~4836.95~3514.12~-1.66~-1.31~-0.80~3294730286126~~-23.47~19.50~3294730286126~~~21.98~-0.06~~CNY~0~~0.00~0~"; v_sh000905="1~中证500~000905~8170.30~8370.52~8279.72~187495413~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-200.22~-2.39~8324.43~8163.13~8170.30/187495413/349830473718~187495413~34983047~1.68~37.11~~8324.43~8163.13~1.93~166244.96~181783.40~0.00~-1~-1~1.10~0~8252.88~~~~~~34983047.3718~0.0000~0~ ~ZS~9.44~-3.95~~~~8671.35~5135.97~-1.42~6.78~11.23~1117453017981~~-37.90~41.31~1117453017981~~~46.18~-0.20~~CNY~0~~0.00~0~"; v_sh000852="1~中证1000~000852~8101.23~8254.86~8166.74~198449167~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-153.63~-1.86~8221.58~8095.07~8101.23/198449167/327566729689~198449167~32756673~2.00~49.82~~8221.58~8095.07~1.53~138872.62~156185.00~0.00~-1~-1~1.02~0~8160.64~~~~~~32756672.9689~0.0000~0~ ~ZS~6.66~-3.16~~~~8530.42~5224.97~-1.99~4.48~7.28~993947220063~~-40.79~31.71~993947220063~~~38.58~-0.13~~CNY~0~~0.00~0~"; v_sh000688="1~科创50~000688~1473.98~1509.40~1492.81~7981140~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-35.42~-2.35~1508.54~1472.57~1473.98/7981140/54694429255~7981140~5469443~1.19~168.74~~1508.54~1472.57~2.38~41438.30~43459.47~0.00~-1~-1~0.88~0~1488.90~~~~~~5469442.9255~0.0000~0~ ~ZS~9.65~-3.84~~~~1588.83~877.71~-2.18~5.03~2.58~67346492369~~33.11~45.99~67346492369~~~54.33~-0.26~~CNY~0~~0.00~0~"; v_sz399001="51~深证成指~399001~14005.20~14205.89~14128.87~530141420~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-200.69~-1.41~14213.61~13993.05~14005.20/530141420/941006422206~530141420~94100642~2.20~52.52~~14213.61~13993.05~1.55~391590.28~456949.27~0.00~-1~-1~1.09~0~14134.41~~~~~~94100642.2206~0.0000~0~ ~ZS~3.55~-2.18~~~~14532.90~9119.60~-2.02~1.28~4.11~2408349594456~~-30.86~36.13~2408349594456~~~37.90~-0.05~~CNY~0~~0.00~0~"; v_sz399005="51~中小100~399005~8459.08~8547.18~8494.98~39136120~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-88.10~-1.03~8561.45~8450.37~8459.08/39136120/101086799831~39136120~10108680~1.31~29.28~~8561.45~8450.37~1.30~71250.71~78478.87~0.00~-1~-1~1.03~0~8513.78~~~~~~10108679.9831~0.0000~0~ ~ZS~2.36~-3.25~~~~8903.43~5710.38~-4.23~0.24~2.99~299175768080~~9.26~32.78~299175768080~~~34.43~-0.06~~CNY~0~~0.00~0~"; v_sz399006="51~创业板指~399006~3309.48~3346.36~3368.14~157335482~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-36.88~-1.10~3390.30~3303.67~3309.48/157335482/460042999910~157335482~46004300~3.05~71.58~~3390.30~3303.67~2.59~148932.36~184391.21~0.00~-1~-1~1.09~0~3352.58~~~~~~46004299.9910~0.0000~0~ ~ZS~3.32~-0.29~~~~3416.84~1756.64~-0.84~0.45~2.63~515314514708~~33.21~60.48~515314514708~~~60.36~0.05~~CNY~0~~0.00~0~"; v_sz399002="51~深成指R~399002~18809.98~19079.52~18976.07~186107931~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130357~-269.54~-1.41~19089.89~18793.66~18809.98/186107931/485511244230~186107931~48551124~1.60~32.50~~19089.89~18793.66~1.55~253018.75~282521.54~0.00~-1~-1~1.03~0~18980.54~~~~~~48551124.4230~0.0000~0~ ~ZS~3.60~-2.17~~~~19517.38~12031.08~-1.99~1.33~4.26~1160300560774~~-35.33~38.32~1160300560774~~~40.42~-0.05~~CNY~0~~0.00~0~"; v_sz399003="51~成份Ｂ指~399003~8075.25~8114.99~8092.44~67320~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202130354~-39.74~-0.49~8137.53~8071.14~8075.25/67320/36152293~67320~3615~0.12~10.27~~8137.53~8071.14~0.82~313.51~313.51~0.00~-1~-1~1.22~0~8104.14~~~~~~3615.2293~0.0000~0~ ~ZS~-2.60~-0.04~~~~9153.62~7572.44~-1.86~-3.66~-6.82~5606747401~~-8.16~-0.19~5606747401~~~1.90~-0.22~~CNY~0~~0.00~0~"; v_hkHSI="100~恒生指数~HSI~26730.780~27387.110~27097.340~17812350.6217~0~0~26730.780~0~0~0~0~0~0~0~0~0~26730.780~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-656.330~-2.40~27100.090~26721.410~26730.780~17812350.6217~17812350.622~0~0~~0~0~1.38~0~0~Hang Seng Index~0~28056.100~19260.210~1.27~18.93~0~0~0~0~0~0.00~0.00~0.00~0~4.29~-0.13~ZS~~~0.63~1.46~3.07~0.00~0.00~0.00~0.000~~13.98~HKD~1~"; v_hkHSCEI="100~国企指数~HSCEI~9064.430~9317.090~9191.350~6211913.1762~0~0~9064.430~0~0~0~0~0~0~0~0~0~9064.430~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-252.660~-2.71~9200.700~9059.970~9064.430~6211913.1762~6211913.176~0~0~~0~0~1.51~0~0~Hang Seng China Enterprises Index~0~9770.210~7100.610~1.15~17.80~0~0~0~0~0~0.00~0.00~0.00~0~1.69~-0.90~ZS~~~-0.77~-0.92~-1.08~0.00~0.00~0.00~0.000~~6.52~HKD~1~"; v_hkHSTECH="100~恒生科技指数~HSTECH~5508.010~5718.180~5644.380~4109878.1640~0~0~5508.010~0~0~0~0~0~0~0~0~0~5508.010~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-210.170~-3.68~5644.380~5505.780~5508.010~4109878.1640~4109878.164~0~0~~0~0~2.42~0~0~Hang Seng TECH Index~0~6715.460~4296.160~1.48~-23.12~0~0~0~0~0~0.00~0.00~0.00~0~-0.14~-3.81~ZS~~~-4.21~-4.07~-4.80~0.00~0.00~0.00~0.000~~3.97~HKD~1~"; v_usIXIC="200~纳斯达克~.IXIC~23461.82~23685.12~23578.96~7920943590~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~~2026-01-30 17:15:59~-223.30~-0.94~23662.25~23351.55~USD~7920943590~185839719470771~~~~~~1.31~~~Nasdaq Composite~~24019.99~14784.03~0~~~~0.95~-0.17~ZS~~~-0.29~0.95~-1.56~~~1.13~~~23461.82~~~"; v_usDJI="200~道琼斯~.DJI~48892.47~49071.56~48991.62~761991988~0~0~48732.39~0~0~0~0~0~0~0~0~0~49039.98~0~0~0~0~0~0~0~0~0~~2026-01-30 16:39:52~-179.09~-0.36~49047.68~48459.88~USD~761991988~37207643103980~~~~~~1.20~~~Dow Jones~~49633.35~36611.78~0~~~~1.73~-0.42~ZS~~~-1.11~1.73~3.29~~~1.46~~~48829.44~~~";`;

  it('应该正确解析完整数据集并输出详细信息', () => {
    const result = parseTencentIndex(mockData);
    
    console.log('\n========== 完整数据集解析结果 ==========');
    result.forEach((index, idx) => {
      console.log(`\n[${idx + 1}] ${index.code} (${index.name})`);
      console.log(`  名称: "${index.name}"`);
      console.log(`  代码: ${index.code}`);
      console.log(`  腾讯代码: ${(index as any).tencentCode || 'N/A'}`);
      console.log(`  价格: ${index.price}`);
      console.log(`  涨跌额: ${index.change}`);
      console.log(`  涨跌幅: ${index.changePercent}%`);
      console.log(`  最高: ${index.high}`);
      console.log(`  最低: ${index.low}`);
      console.log(`  PE: ${index.pe}`);
      console.log(`  名称是否包含中文: ${/[\u4e00-\u9fa5]/.test(index.name)}`);
      // eslint-disable-next-line no-control-regex
      console.log(`  名称是否乱码: ${index.name.includes('�') || index.name.includes('?') || (/^[\x00-\x7F]+$/.test(index.name) && index.name !== index.code && !index.name.match(/^[A-Z]+$/))}`);
    });
    console.log('\n==========================================\n');
    
    expect(result).toHaveLength(16); // 11个沪深 + 3个港股 + 2个美股
    
    // 验证每个指数的名称是否正确
    const nameMap: Record<string, string> = {
      // 沪深指数
      '000001': '上证指数',
      '000016': '上证50',
      '000300': '沪深300',
      '000905': '中证500',
      '000852': '中证1000',
      '000688': '科创50',
      '399001': '深证成指',
      '399005': '中小100',
      '399006': '创业板指',
      '399002': '深成指R',
      '399003': '成份Ｂ指',
      // 港股（code 可能是 hkHSI 或 HSI）
      // 注意：港股美股会强制使用预定义名称，所以期望是预定义名称
      'hkHSI': '恒生指数',
      'HSI': '恒生指数',
      'hkHSCEI': '恒生国企', // INDEX_CODES 中的名称
      'HSCEI': '恒生国企', // INDEX_CODES 中的名称（应该被覆盖）
      'hkHSTECH': '恒生科技',
      'HSTECH': '恒生科技',
      // 美股（code 可能是 usIXIC 或 .IXIC）
      'usIXIC': '纳斯达克',
      '.IXIC': '纳斯达克',
      'usDJI': '道琼斯',
      '.DJI': '道琼斯',
    };
    
    result.forEach((index) => {
      const expectedName = nameMap[index.code];
      expect(expectedName).toBeDefined();
      expect(index.name).toBe(expectedName);
      expect(/[\u4e00-\u9fa5]/.test(index.name)).toBe(true);
      expect(index.name).not.toContain('�');
      expect(index.name).not.toContain('?');
    });
    
    // 验证去重：不应该有重复的 code
    const codes = result.map(r => r.code);
    const uniqueCodes = [...new Set(codes)];
    expect(codes.length).toBe(uniqueCodes.length);
  });

  it('应该正确解析多条指数数据', () => {
    const result = parseTencentIndex(mockData);
    
    expect(result).toHaveLength(16); // 11个沪深 + 3个港股 + 2个美股
  });

  it('应该正确解析上证指数数据', () => {
    const result = parseTencentIndex(mockData);
    const shIndex = result.find((idx) => idx.code === '000001');
    
    expect(shIndex).toBeDefined();
    expect(shIndex?.name).toBe('上证指数');
    expect(shIndex?.code).toBe('000001');
    // 使用新数据中的价格
    expect(shIndex?.price).toBe(4062.55);
    expect(shIndex?.prevClose).toBe(4117.95);
    expect(shIndex?.open).toBe(4079.71);
    // 字段31是涨跌额，值为-55.40
    expect(shIndex?.change).toBeCloseTo(-55.40, 2);
    // 字段32是涨跌幅，值为-1.35
    expect(shIndex?.changePercent).toBeCloseTo(-1.35, 2);
    expect(shIndex?.high).toBe(4103.41);
    expect(shIndex?.low).toBe(4059.79);
    // PE在字段39，值为17.27
    expect(shIndex?.pe).toBe(17.27);
  });

  it('应该正确解析深证成指数据', () => {
    const result = parseTencentIndex(mockData);
    const szIndex = result.find((idx) => idx.code === '399001');
    
    expect(szIndex).toBeDefined();
    expect(szIndex?.name).toBe('深证成指');
    expect(szIndex?.code).toBe('399001');
    // 使用新数据中的价格
    expect(szIndex?.price).toBe(14005.20);
    expect(szIndex?.prevClose).toBe(14205.89);
    expect(szIndex?.open).toBe(14128.87);
    // 字段31是涨跌额，值为-200.69
    expect(szIndex?.change).toBeCloseTo(-200.69, 2);
    // 字段32是涨跌幅，值为-1.41
    expect(szIndex?.changePercent).toBeCloseTo(-1.41, 2);
    expect(szIndex?.high).toBe(14213.61);
    expect(szIndex?.low).toBe(13993.05);
    // PE在字段39，值为52.52
    expect(szIndex?.pe).toBe(52.52);
  });

  it('应该正确解析创业板指数据（关键测试：399006）', () => {
    const result = parseTencentIndex(mockData);
    const cybIndex = result.find((idx) => idx.code === '399006');
    
    expect(cybIndex).toBeDefined();
    expect(cybIndex?.name).toBe('创业板指'); // 关键：应该正确显示名称，不是乱码
    expect(cybIndex?.code).toBe('399006');
    // 使用新数据中的价格
    expect(cybIndex?.price).toBe(3309.48);
    expect(cybIndex?.prevClose).toBe(3346.36);
    expect(cybIndex?.open).toBe(3368.14);
    // 字段31是涨跌额，值为-36.88
    expect(cybIndex?.change).toBeCloseTo(-36.88, 2);
    // 字段32是涨跌幅，值为-1.10
    expect(cybIndex?.changePercent).toBeCloseTo(-1.10, 2);
    expect(cybIndex?.high).toBe(3390.30);
    expect(cybIndex?.low).toBe(3303.67);
    // PE在字段39，值为71.58
    expect(cybIndex?.pe).toBe(71.58);
  });

  it('应该正确处理空数据', () => {
    const result = parseTencentIndex('');
    expect(result).toHaveLength(0);
  });

  it('应该正确处理无效数据', () => {
    const invalidData = 'v_sh000001="invalid~data";';
    const result = parseTencentIndex(invalidData);
    // 应该跳过无效数据或返回空数组
    expect(Array.isArray(result)).toBe(true);
  });

  it('应该正确计算涨跌额（当字段29不存在时）', () => {
    const dataWithoutChange = `v_sh000001="1~上证指数~000001~4063.54~4117.95~4079.71~450162571~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202114100~~-1.32~4103.41~4063.12~4063.54/450162571/725756847415~450162571~72575685~0.94~17.28~~4103.41~4063.12~0.98~623890.61~663899.78~0.00~-1~-1~1.08~0~4088.93~~~~~~72575684.7415~0.0000~0~ ~ZS~2.39~-1.67~~~~4190.87~3040.69~-1.23~1.00~1.39~4785495256275~~-21.01~20.41~4785495256275~~~25.01~-0.18~~CNY~0~~0.00~0~";`;
    const result = parseTencentIndex(dataWithoutChange);
    const index = result[0];
    
    if (index) {
      // 应该计算：4063.54 - 4117.95 = -54.41
      expect(index.change).toBeCloseTo(-54.41, 2);
    }
  });

  it('应该正确计算涨跌幅（当字段31和32不存在时）', () => {
    // 构造一个字段31和32为空的测试数据
    // 需要确保字段数量足够（至少40个字段，因为PE在字段39）
    const fields = [
      '1', '上证指数', '000001', '4063.54', '4117.95', '4079.71', // 0-5
      '450162571', '0', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', // 6-28
      '', '20260202114100', '', '', '4103.41', '4063.12', // 29-34 (字段31和32都为空)
      '4063.54/450162571/725756847415', '450162571', '72575685', '0.94', '17.28', // 35-39
    ];
    // 确保有足够的字段
    while (fields.length < 40) {
      fields.push('');
    }
    const dataWithoutChangePercent = `v_sh000001="${fields.join('~')}";`;
    const result = parseTencentIndex(dataWithoutChangePercent);
    const index = result[0];
    
    expect(index).toBeDefined();
    if (index) {
      // 字段31和32都为空，所以会计算：
      // change = 4063.54 - 4117.95 = -54.41
      // changePercent = ((4063.54 - 4117.95) / 4117.95) * 100 ≈ -1.32
      expect(index.change).toBeCloseTo(-54.41, 2);
      expect(index.changePercent).toBeCloseTo(-1.32, 2);
    }
  });

  it('应该过滤异常的PE值', () => {
    const dataWithInvalidPE = `v_sh000001="1~上证指数~000001~4063.54~4117.95~4079.71~450162571~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202114100~-54.41~-1.32~4103.41~4063.12~4063.54/450162571/725756847415~450162571~72575685~0.94~999999~4103.41~4063.12~0.98~623890.61~663899.78~0.00~-1~-1~1.08~0~4088.93~~~~~~72575684.7415~0.0000~0~ ~ZS~2.39~-1.67~~~~4190.87~3040.69~-1.23~1.00~1.39~4785495256275~~-21.01~20.41~4785495256275~~~25.01~-0.18~~CNY~0~~0.00~0~";`;
    const result = parseTencentIndex(dataWithInvalidPE);
    const index = result[0];
    
    if (index) {
      // PE值999999应该被过滤为0
      expect(index.pe).toBe(0);
    }
  });

  it('应该过滤异常的涨跌幅值', () => {
    // 构造一个字段32为9999的测试数据（异常大的涨跌幅）
    const fields = [
      '1', '上证指数', '000001', '4063.54', '4117.95', '4079.71', // 0-5
      '450162571', '0', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', '0.00', '0', // 6-28
      '', '20260202114100', '-54.41', '9999', '4103.41', '4063.12', // 29-34 (字段32是9999)
      '4063.54/450162571/725756847415', '450162571', '72575685', '0.94', '17.28', // 35-39
    ];
    // 确保有足够的字段
    while (fields.length < 40) {
      fields.push('');
    }
    const dataWithInvalidChangePercent = `v_sh000001="${fields.join('~')}";`;
    const result = parseTencentIndex(dataWithInvalidChangePercent);
    const index = result[0];
    
    expect(index).toBeDefined();
    if (index) {
      // 涨跌幅9999 >= 100，会被识别为时间戳，回退到计算
      // 计算出的值：((4063.54 - 4117.95) / 4117.95) * 100 ≈ -1.32
      // 这个值 < 1000，所以会被保留
      expect(index.changePercent).toBeCloseTo(-1.32, 2);
    }
  });

  it('应该正确处理字段不足的数据', () => {
    const incompleteData = `v_sh000001="1~上证指数~000001~4063.54";`;
    const result = parseTencentIndex(incompleteData);
    
    // 应该跳过字段不足的数据
    expect(result).toHaveLength(0);
  });

  it('应该正确处理PE为0或空的情况', () => {
    const dataWithZeroPE = `v_sh000001="1~上证指数~000001~4063.54~4117.95~4079.71~450162571~0~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20260202114100~-54.41~-1.32~4103.41~4063.12~4063.54/450162571/725756847415~450162571~72575685~0.94~0~4103.41~4063.12~0.98~623890.61~663899.78~0.00~-1~-1~1.08~0~4088.93~~~~~~72575684.7415~0.0000~0~ ~ZS~2.39~-1.67~~~~4190.87~3040.69~-1.23~1.00~1.39~4785495256275~~-21.01~20.41~4785495256275~~~25.01~-0.18~~CNY~0~~0.00~0~";`;
    const result = parseTencentIndex(dataWithZeroPE);
    const index = result[0];
    
    if (index) {
      // PE为0应该返回0
      expect(index.pe).toBe(0);
    }
  });

  it('应该正确解析港股和美股数据并处理乱码', () => {
    // 使用用户提供的港股和美股数据
    const hkUsData = `v_hkHSI="100~恒生指数~HSI~26730.780~27387.110~27097.340~17812350.6217~0~0~26730.780~0~0~0~0~0~0~0~0~0~26730.780~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-656.330~-2.40~27100.090~26721.410~26730.780~17812350.6217~17812350.622~0~0~~0~0~1.38~0~0~Hang Seng Index~0~28056.100~19260.210~1.27~19.02~0~0~0~0~0~0.00~0.00~0.00~0~4.29~-0.13~ZS~~~0.63~1.46~3.07~0.00~0.00~0.00~0.000~~13.98~HKD~1~"; v_hkHSCEI="100~国企指数~HSCEI~9064.430~9317.090~9191.350~6211913.1762~0~0~9064.430~0~0~0~0~0~0~0~0~0~9064.430~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-252.660~-2.71~9200.700~9059.970~9064.430~6211913.1762~6211913.176~0~0~~0~0~1.51~0~0~Hang Seng China Enterprises Index~0~9770.210~7100.610~1.15~17.91~0~0~0~0~0~0.00~0.00~0.00~0~1.69~-0.90~ZS~~~-0.77~-0.92~-1.08~0.00~0.00~0.00~0.000~~6.52~HKD~1~"; v_hkHSTECH="100~恒生科技指数~HSTECH~5508.010~5718.180~5644.380~4109878.1640~0~0~5508.010~0~0~0~0~0~0~0~0~0~5508.010~0~0~0~0~0~0~0~0~0~0.0~2026/02/02 11:59:59~-210.170~-3.68~5644.380~5505.780~5508.010~4109878.1640~4109878.164~0~0~~0~0~2.42~0~0~Hang Seng TECH Index~0~6715.460~4296.160~1.48~-21.73~0~0~0~0~0~0.00~0.00~0.00~0~-0.14~-3.81~ZS~~~-4.21~-4.07~-4.80~0.00~0.00~0.00~0.000~~3.97~HKD~1~"; v_usIXIC="200~纳斯达克~.IXIC~23461.82~23685.12~23578.96~7920943590~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~0~~2026-01-30 17:15:59~-223.30~-0.94~23662.25~23351.55~USD~7920943590~185839719470771~~~~~~1.31~~~Nasdaq Composite~~24019.99~14784.03~0~~~~0.95~-0.17~ZS~~~-0.29~0.95~-1.56~~~1.13~~~23461.82~~~"; v_usDJI="200~道琼斯~.DJI~48892.47~49071.56~48991.62~761991988~0~0~48732.39~0~0~0~0~0~0~0~0~0~49039.98~0~0~0~0~0~0~0~0~0~~2026-01-30 16:39:52~-179.09~-0.36~49047.68~48459.88~USD~761991988~37207643103980~~~~~~1.20~~~Dow Jones~~49633.35~36611.78~0~~~~1.73~-0.42~ZS~~~-1.11~1.73~3.29~~~1.46~~~48829.44~~~";`;
    
    const result = parseTencentIndex(hkUsData);
    
    console.log('\n========== 港股美股解析结果 ==========');
    result.forEach((index, idx) => {
      console.log(`\n[${idx + 1}] ${index.code} (${index.name})`);
      console.log(`  名称: "${index.name}"`);
      console.log(`  代码: ${index.code}`);
      console.log(`  腾讯代码: ${(index as any).tencentCode || 'N/A'}`);
      console.log(`  价格: ${index.price}`);
      console.log(`  涨跌额: ${index.change}`);
      console.log(`  涨跌幅: ${index.changePercent}%`);
      console.log(`  名称是否包含中文: ${/[\u4e00-\u9fa5]/.test(index.name)}`);
    });
    console.log('\n==========================================\n');
    
    expect(result).toHaveLength(5); // 3个港股 + 2个美股
    
    // 验证港股名称（code 可能是 hkHSI 或 HSI）
    // 注意：INDEX_CODES 中 HSCEI 的名称是 '恒生国企'，但实际数据返回的是 '国企指数'
    // 我们的逻辑应该使用预定义名称覆盖，所以期望是 '恒生国企'
    const hkNameMap: Record<string, string> = {
      'hkHSI': '恒生指数',
      'HSI': '恒生指数',
      'hkHSCEI': '恒生国企',
      'HSCEI': '恒生国企', // INDEX_CODES 中的名称
      'hkHSTECH': '恒生科技',
      'HSTECH': '恒生科技',
    };
    
    // 验证美股名称（code 可能是 usIXIC 或 .IXIC）
    const usNameMap: Record<string, string> = {
      'usIXIC': '纳斯达克',
      '.IXIC': '纳斯达克',
      'usDJI': '道琼斯',
      '.DJI': '道琼斯',
    };
    
    result.forEach((index) => {
      const expectedName = hkNameMap[index.code] || usNameMap[index.code];
      expect(expectedName).toBeDefined();
      // 如果原始名称是中文且不是乱码，应该使用预定义名称覆盖（如果存在）
      // 但测试数据中 HSCEI 的原始名称是 '国企指数'，而 INDEX_CODES 中是 '恒生国企'
      // 所以这里我们验证名称是中文且不是乱码即可
      expect(/[\u4e00-\u9fa5]/.test(index.name)).toBe(true);
      expect(index.name).not.toContain('�');
      expect(index.name).not.toContain('?');
      
      // 如果预定义名称存在，应该使用预定义名称
      if (expectedName && index.name !== expectedName) {
        // 检查是否应该使用预定义名称
        const tencentCode = (index as any).tencentCode || '';
        if (tencentCode && (tencentCode.startsWith('hk') || tencentCode.startsWith('us'))) {
          // 港股美股应该使用预定义名称
          expect(index.name).toBe(expectedName);
        }
      }
    });
    
    // 验证去重：不应该有重复的 code
    const codes = result.map(r => r.code);
    const uniqueCodes = [...new Set(codes)];
    expect(codes.length).toBe(uniqueCodes.length);
  });
});
